<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPY Staking DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, button, textarea { padding: 0.5rem; margin: 0.5rem 0; width: 100%; max-width: 400px; }
    .section { border: 1px solid #ddd; padding: 1rem; margin-bottom: 2rem; }
    .result { margin-top: 1rem; }
    label { display: block; margin-top: 1rem; }
    pre { background: #f8f8f8; padding: 0.5rem; }
    .admin-section { background-color: #fff8f8; }
  </style>
</head>
<body>
  <h1>TPY Staking DApp</h1>
  
  <!-- Wallet Connection -->
  <div class="section">
    <h2>Wallet Connection</h2>
    <button id="connectWalletButton">Connect Wallet</button>
    <p><strong>Connected Address:</strong> <span id="walletAddress">Not connected</span></p>
  </div>
  
  <!-- User Functions Section -->
  <div class="section">
    <h2>User Functions</h2>
    
    <!-- Stake Section -->
    <h3>Stake Tokens</h3>
    <label for="stakePoolId">Pool ID:</label>
    <input type="number" id="stakePoolId" value="0" />
    
    <label for="stakeAmount">Amount to Stake:</label>
    <input type="text" id="stakeAmount" placeholder="Amount in smallest unit" />
    
    <label for="referrerId">Referrer ID (optional):</label>
    <input type="number" id="referrerId" value="0" />
    
    <button id="stakeButton">Stake</button>
    <div class="result">
      <pre id="stakeResult">-</pre>
    </div>
    
    <!-- Unstake Section -->
    <h3>Unstake Tokens</h3>
    <label for="unstakePoolId">Pool ID:</label>
    <input type="number" id="unstakePoolId" value="0" />
    
    <label for="unstakeAmount">Amount to Unstake:</label>
    <input type="text" id="unstakeAmount" placeholder="Amount in smallest unit" />
    
    <button id="unstakeButton">Unstake</button>
    <div class="result">
      <pre id="unstakeResult">-</pre>
    </div>
    
    <!-- Emergency Unstake Section -->
    <h3>Emergency Unstake</h3>
    <label for="emergencyPoolId">Pool ID:</label>
    <input type="number" id="emergencyPoolId" value="0" />
    
    <button id="emergencyUnstakeButton">Emergency Unstake</button>
    <div class="result">
      <pre id="emergencyResult">-</pre>
    </div>
  </div>
  
  <!-- Read Functions Section -->
  <div class="section">
    <h2>Read Contract Data</h2>
    
    <!-- Total Stakes -->
    <button id="readTotalStakesButton">Get Total Stakes</button>
    <div class="result">
      <pre id="readTotalStakesResult">-</pre>
    </div>
    
    <!-- Pool Info -->
    <label for="poolIdRead">Pool ID for Pool Info:</label>
    <input type="number" id="poolIdRead" value="0" />
    <button id="readPoolInfoButton">Get Pool Info</button>
    <div class="result">
      <pre id="readPoolInfoResult">-</pre>
    </div>
    
    <!-- User Stake Info -->
    <label for="stakeInfoPoolId">Pool ID for Stake Info:</label>
    <input type="number" id="stakeInfoPoolId" value="0" />
    <label for="stakeInfoAddress">Address (optional, defaults to connected wallet):</label>
    <input type="text" id="stakeInfoAddress" placeholder="0x..." />
    <button id="readUserStakeInfoButton">Get Stake Info</button>
    <div class="result">
      <pre id="readUserStakeInfoResult">-</pre>
    </div>
    
    <!-- Referral Info -->
    <h3>Referral System Info</h3>
    <label for="referralAddress">Address (optional, defaults to connected wallet):</label>
    <input type="text" id="referralAddress" placeholder="0x..." />
    <button id="readUserReferrerButton">Get Referrer</button>
    <div class="result">
      <pre id="readUserReferrerResult">-</pre>
    </div>
    
    <!-- ID Mappings -->
    <h3>ID Mappings</h3>
    <label for="addressToIdInput">Address to check ID:</label>
    <input type="text" id="addressToIdInput" placeholder="0x..." />
    <button id="getAddressToIdButton">Get ID</button>
    <div class="result">
      <pre id="addressToIdResult">-</pre>
    </div>
    
    <label for="idToAddressInput">ID to check address:</label>
    <input type="number" id="idToAddressInput" value="0" />
    <button id="getIdToAddressButton">Get Address</button>
    <div class="result">
      <pre id="idToAddressResult">-</pre>
    </div>
  </div>
  
  <!-- Admin Functions Section -->
  <div class="section admin-section">
    <h2>Admin Functions</h2>
    
    <!-- Add Pool -->
    <h3>Add New Pool</h3>
    <label for="addPoolApy">APY (e.g., 1050 for 10.5%):</label>
    <input type="number" id="addPoolApy" value="1000" />
    
    <label for="addPoolLockPeriod">Lock Period (seconds):</label>
    <input type="number" id="addPoolLockPeriod" value="2592000" />
    
    <button id="addPoolButton">Add Pool</button>
    <div class="result">
      <pre id="addPoolResult">-</pre>
    </div>
    
    <!-- Change Pool -->
    <h3>Change Pool</h3>
    <label for="changePoolId">Pool ID:</label>
    <input type="number" id="changePoolId" value="0" />
    
    <label for="changePoolApy">New APY:</label>
    <input type="number" id="changePoolApy" value="1000" />
    
    <label for="changePoolLockPeriod">New Lock Period (seconds):</label>
    <input type="number" id="changePoolLockPeriod" value="2592000" />
    
    <button id="changePoolButton">Change Pool</button>
    <div class="result">
      <pre id="changePoolResult">-</pre>
    </div>
    
    <!-- Pause Pool -->
    <h3>Pause Pool</h3>
    <label for="pausePoolId">Pool ID:</label>
    <input type="number" id="pausePoolId" value="0" />
    
    <button id="pausePoolButton">Pause Pool</button>
    <div class="result">
      <pre id="pausePoolResult">-</pre>
    </div>
    
    <!-- Set Referrer Reward -->
    <h3>Set Referrer Reward</h3>
    <label for="setReward">New Referrer Reward (%):</label>
    <input type="number" id="setReward" value="20" />
    
    <button id="setRewardButton">Set Referrer Reward</button>
    <div class="result">
      <pre id="setRewardResult">-</pre>
    </div>
    
    <!-- Set Treasury Address -->
    <h3>Set Treasury Address</h3>
    <label for="setTreasuryAddress">New Treasury Address:</label>
    <input type="text" id="setTreasuryAddress" placeholder="0x..." />
    
    <button id="setTreasuryButton">Set Treasury</button>
    <div class="result">
      <pre id="setTreasuryResult">-</pre>
    </div>
    
    <!-- Rescue Tokens -->
    <h3>Rescue Tokens</h3>
    <label for="rescueToken">Token Address:</label>
    <input type="text" id="rescueToken" placeholder="0x..." />
    
    <label for="rescueAmount">Amount:</label>
    <input type="text" id="rescueAmount" placeholder="Amount in smallest unit" />
    
    <button id="rescueTokensButton">Rescue Tokens</button>
    <div class="result">
      <pre id="rescueTokensResult">-</pre>
    </div>
  </div>
  
  <script>
    // Fixed contract configuration
    const CONTRACT_ADDRESS = "0xBbB449a875bAD0bc422758F0E08e86202E500eD3";
    const RPC_ENDPOINT = "https://rpc.sepolia.org";
    
    let signer;
    let contract;
    const tpyStakingABI = [
      // User functions
      "function stake(uint256 pid_, uint256 amount_, uint256 referrerId_) external",
      "function unstake(uint256 pid_, uint256 amount_) external",
      "function emergencyUnstake(uint256 pid_) external",
      
      // Admin functions
      "function addPool(uint256 apy_, uint256 lockPeriod_) external",
      "function changePool(uint256 pid_, uint256 newApy_, uint256 newLockPeriod_) external",
      "function pausePool(uint256 pid_) external",
      "function setReferrerReward(uint256 newReferrerReward_) external",
      "function setTreasuryAddress(address newTreasury_) external",
      "function inCaseTokensGetStuck(address token_, uint256 amount_) external",
      
      // Read functions
      "function totalStakes() view returns (uint256)",
      "function poolInfo(uint256) view returns (bool isPaused, uint256 lockPeriod, uint256 apy, uint256 totalStakes, uint256 pauseCheckpoint)",
      "function stakes(uint256, address) view returns (uint256 amount, uint256 checkpoint, uint256 releaseCheckpoint)",
      "function stakeOfAuto(uint256, address) view returns (uint256)",
      "function userReferrer(address) view returns (address)",
      "function addressToId(address) view returns (uint256)",
      "function idToAddress(uint256) view returns (address)",
      "function referrerReward() view returns (uint256)",
      "function hasRole(bytes32 role, address account) view returns (bool)"
    ];
    
    // Connect wallet and instantiate contract
    async function connectWallet() {
      if (window.ethereum) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        document.getElementById('walletAddress').innerText = userAddress;
        
        // Check if we're on Sepolia
        const network = await provider.getNetwork();
        if (network.chainId !== 11155111) {
          alert("Please switch to Sepolia network");
          return;
        }
        
        // Instantiate the contract
        contract = new ethers.Contract(CONTRACT_ADDRESS, tpyStakingABI, signer);
        
        // Check if user is admin and show/hide admin section
        const DEFAULT_ADMIN_ROLE = '0x0000000000000000000000000000000000000000000000000000000000000000';
        const isAdmin = await contract.hasRole(DEFAULT_ADMIN_ROLE, userAddress);
        document.querySelector('.admin-section').style.display = isAdmin ? 'block' : 'none';
      } else {
        alert("Please install a Web3 wallet like MetaMask.");
      }
    }
    
    document.getElementById('connectWalletButton').addEventListener('click', connectWallet);
    
    // Write functions
    document.getElementById('stakeButton').addEventListener('click', async () => {
      const poolId = document.getElementById('stakePoolId').value;
      const amount = document.getElementById('stakeAmount').value;
      const referrerId = document.getElementById('referrerId').value;
      try {
        const tx = await contract.stake(poolId, amount, referrerId);
        document.getElementById('stakeResult').innerText = "Transaction sent: " + tx.hash;
        await tx.wait();
        document.getElementById('stakeResult').innerText = "Stake successful: " + tx.hash;
      } catch (error) {
        document.getElementById('stakeResult').innerText = "Error: " + error.message;
      }
    });
    
    document.getElementById('unstakeButton').addEventListener('click', async () => {
      const poolId = document.getElementById('unstakePoolId').value;
      const amount = document.getElementById('unstakeAmount').value;
      try {
        const tx = await contract.unstake(poolId, amount);
        document.getElementById('unstakeResult').innerText = "Transaction sent: " + tx.hash;
        await tx.wait();
        document.getElementById('unstakeResult').innerText = "Unstake successful: " + tx.hash;
      } catch (error) {
        document.getElementById('unstakeResult').innerText = "Error: " + error.message;
      }
    });
    
    document.getElementById('emergencyUnstakeButton').addEventListener('click', async () => {
      const poolId = document.getElementById('emergencyPoolId').value;
      try {
        const tx = await contract.emergencyUnstake(poolId);
        document.getElementById('emergencyResult').innerText = "Transaction sent: " + tx.hash;
        await tx.wait();
        document.getElementById('emergencyResult').innerText = "Emergency unstake successful: " + tx.hash;
      } catch (error) {
        document.getElementById('emergencyResult').innerText = "Error: " + error.message;
      }
    });
    
    // Admin functions
    document.getElementById('addPoolButton').addEventListener('click', async () => {
      const apy = document.getElementById('addPoolApy').value;
      const lockPeriod = document.getElementById('addPoolLockPeriod').value;
      try {
        const tx = await contract.addPool(apy, lockPeriod);
        document.getElementById('addPoolResult').innerText = "Transaction sent: " + tx.hash;
        await tx.wait();
        document.getElementById('addPoolResult').innerText = "Pool added: " + tx.hash;
      } catch (error) {
        document.getElementById('addPoolResult').innerText = "Error: " + error.message;
      }
    });
    
    document.getElementById('changePoolButton').addEventListener('click', async () => {
      const poolId = document.getElementById('changePoolId').value;
      const newApy = document.getElementById('changePoolApy').value;
      const newLockPeriod = document.getElementById('changePoolLockPeriod').value;
      try {
        const tx = await contract.changePool(
